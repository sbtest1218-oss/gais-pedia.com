name: Deploy to EC2

on:
  push:
    branches: [ master ]
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚’è¨±å¯

jobs:
  test:
    runs-on: ubuntu-latest
    # srcãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’working-directoryã«è¨­å®š
    defaults:
      run:
        working-directory: src
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, xml, ctype, json, bcmath

    - name: Install dependencies
      run: composer install --prefer-dist --no-progress

    # ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
    - name: Run tests
      run: |
        cp .env.example .env
        php artisan key:generate
        php artisan test

  deploy:
    needs: test  # testã‚¸ãƒ§ãƒ–ãŒæˆåŠŸã—ãŸå ´åˆã®ã¿å®Ÿè¡Œ
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master'  # masterãƒ–ãƒ©ãƒ³ãƒã¸ã®pushã®ã¿ãƒ‡ãƒ—ãƒ­ã‚¤

    steps:
    # AWSèªè¨¼æƒ…å ±ã‚’è¨­å®š
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}

    # Systems Managerã‚’ä½¿ç”¨ã—ã¦EC2ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
    - name: Deploy to EC2 via SSM
      id: deploy
      run: |
        # SSMã§ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ
        COMMAND_ID=$(aws ssm send-command \
          --instance-ids ${{ secrets.EC2_INSTANCE_ID }} \
          --document-name "AWS-RunShellScript" \
          --comment "Deploy from GitHub Actions" \
          --parameters 'commands=[
            "cd /home/ec2-user/gais-pedia.com",
            "sudo -u ec2-user bash /home/ec2-user/gais-pedia.com/deploy.sh"
          ]' \
          --output text \
          --query "Command.CommandId")

        echo "Command ID: $COMMAND_ID"
        echo "command_id=$COMMAND_ID" >> $GITHUB_OUTPUT

        # ã‚³ãƒãƒ³ãƒ‰å®Œäº†ã‚’å¾…æ©Ÿ(æœ€å¤§5åˆ†)
        echo "â³ Waiting for deployment to complete..."
        aws ssm wait command-executed \
          --command-id "$COMMAND_ID" \
          --instance-id ${{ secrets.EC2_INSTANCE_ID }} \
          --cli-read-timeout 300

        # ã‚³ãƒãƒ³ãƒ‰çµæœã‚’å–å¾—
        STATUS=$(aws ssm get-command-invocation \
          --command-id "$COMMAND_ID" \
          --instance-id ${{ secrets.EC2_INSTANCE_ID }} \
          --query "Status" \
          --output text)

        OUTPUT=$(aws ssm get-command-invocation \
          --command-id "$COMMAND_ID" \
          --instance-id ${{ secrets.EC2_INSTANCE_ID }} \
          --query "StandardOutputContent" \
          --output text)

        ERROR_OUTPUT=$(aws ssm get-command-invocation \
          --command-id "$COMMAND_ID" \
          --instance-id ${{ secrets.EC2_INSTANCE_ID }} \
          --query "StandardErrorContent" \
          --output text)

        echo "ğŸ“‹ Deployment output:"
        echo "$OUTPUT"

        # ãƒ‡ãƒ—ãƒ­ã‚¤çµæœã‚’ç¢ºèª
        if [ "$STATUS" != "Success" ]; then
          echo "âŒ Deployment failed with status: $STATUS"
          echo "ğŸ”´ Error output:"
          echo "$ERROR_OUTPUT"
          exit 1
        fi

        echo "âœ… Deployment completed successfully!"

    # ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’é€šçŸ¥
    - name: Notify deployment status
      if: always()
      run: |
        if [ ${{ job.status }} == 'success' ]; then
          echo "âœ… Deployment succeeded!"
        else
          echo "âŒ Deployment failed!"
        fi